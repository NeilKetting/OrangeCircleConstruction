<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:vm="clr-namespace:OCC.Client.ViewModels.Shared"
			 xmlns:conv="clr-namespace:OCC.Client.Converters"
			 xmlns:local="clr-namespace:OCC.Client.Views.Shared"
			 mc:Ignorable="d" d:DesignWidth="250" d:DesignHeight="800"
			 x:Class="OCC.Client.Views.Shared.SidebarView"
			 x:DataType="vm:SidebarViewModel"
			 Focusable="True"
			 PointerPressed="Sidebar_PointerPressed">

	<Design.DataContext>
		<vm:SidebarViewModel/>
	</Design.DataContext>

	<UserControl.Resources>
		<conv:StringEqualityConverter x:Key="StringEqualityConverter"/>
	</UserControl.Resources>

	<UserControl.KeyBindings>
		<KeyBinding Gesture="T" Command="{Binding NewTaskCommand}"/>
		<KeyBinding Gesture="M" Command="{Binding NewMeetingCommand}"/>
		<KeyBinding Gesture="P" Command="{Binding NewProjectCommand}"/>
		<KeyBinding Gesture="I" Command="{Binding InviteUserCommand}"/>
	</UserControl.KeyBindings>

	<Border Background="{DynamicResource SurfaceLightGray}"			
			Width="{Binding IsCollapsed, Converter={x:Static conv:SidebarConverters.CollapseWidth}}">
		<Grid RowDefinitions="Auto,*,Auto">
			<!-- Logo area -->
			<StackPanel Grid.Row="0" Margin="20,25" Orientation="Horizontal" Spacing="10" Background="Transparent" DoubleTapped="Sidebar_DoubleTapped">
				<Border Classes="LogoContainer" Width="32" Height="32">
					<Ellipse Width="35" Height="35" Stroke="{DynamicResource AccentOrange}" StrokeThickness="3"/>
				</Border>
				<StackPanel>
					<TextBlock Text="Orange Circle" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryDark}"/>
					<TextBlock Text="Construction" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryDark}" HorizontalAlignment="Center"/>

				</StackPanel>
			</StackPanel>

			<!-- Navigation Links -->
			<ScrollViewer Grid.Row="1">
				<StackPanel Margin="-1">
					<Button Classes="SidebarButton" Command="{Binding NavigateCommand}" CommandParameter="Home" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Home'}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconHome}" Classes="IconStyle"/>
							<TextBlock Text="Home" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="SidebarButton" Command="{Binding NavigateCommand}" CommandParameter="Notifications" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Notifications'}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconNotifications}" Classes="IconStyle"/>
							<TextBlock Text="Notifications" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="SidebarButton" Command="{Binding NavigateCommand}" CommandParameter="Time" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Time'}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconTime}" Classes="IconStyle"/>
							<TextBlock Text="Time &amp; Attendance" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="SidebarButton" Command="{Binding NavigateCommand}" CommandParameter="Team" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Team'}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconTeam}" Classes="IconStyle"/>
							<TextBlock Text="Employee Management" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="SidebarButton" Command="{Binding ToggleProjectsCommand}" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Portfolio'}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconPortfolio}" Classes="IconStyle"/>
							<TextBlock Text="Projects" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
                            
                            <!-- Chevron that rotates -->
							<PathIcon Data="{StaticResource IconChevronDown}" 
                                      Width="10" Height="10" 
                                      HorizontalAlignment="Right" 
                                      IsVisible="{Binding !IsCollapsed}" 
                                      Margin="0,2,0,0">
                                <PathIcon.RenderTransform>
                                    <RotateTransform Angle="{Binding IsProjectsExpanded, Converter={x:Static conv:SidebarConverters.BoolToRotation}, FallbackValue=0}"/>
                                </PathIcon.RenderTransform>
                            </PathIcon>
						</StackPanel>
					</Button>

                    <!-- Collapsible Section -->
                    <StackPanel IsVisible="{Binding IsProjectsExpanded}" Margin="20,0,0,0">
                        
                        <!-- Search Bar -->
                        <TextBox Classes="3" 
                                 Watermark="Search..." 
                                 Text="{Binding ProjectSearchText}"
                                 Height="30"
                                 FontSize="12"
                                 Margin="10,0,10,5"
                                 Padding="8,5"
								 VerticalContentAlignment="Center"
                                 IsVisible="{Binding !IsCollapsed}"/>

                        <!-- Projects List (Scrollable & Tree-like) -->
                        <ScrollViewer MaxHeight="300" IsVisible="{Binding !IsCollapsed}" Margin="0,0,0,10">
                            <ItemsControl ItemsSource="{Binding Projects}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Classes="SidebarButton" 
                                                Command="{Binding $parent[UserControl].((vm:SidebarViewModel)DataContext).NavigateToProjectCommand}" 
                                                CommandParameter="{Binding}"
                                                Padding="10,8"
                                                HorizontalAlignment="Stretch"
                                                HorizontalContentAlignment="Left"
                                                Margin="10,1">
                                            <Grid ColumnDefinitions="Auto, *">
                                                 <!-- Tree Line -->
                                                <Border Grid.Column="0" Width="1" Background="{DynamicResource BorderGray}" HorizontalAlignment="Left" Margin="12,-15,0,-15"/>
                                                <Border Grid.Column="0" Width="10" Height="1" Background="{DynamicResource BorderGray}" HorizontalAlignment="Left" Margin="12,0,0,0" VerticalAlignment="Center"/>
                                                
                                                <!-- Project Name -->
                                                <TextBlock Grid.Column="1" Text="{Binding Name}" Margin="10,0,0,0" FontSize="13" Foreground="{DynamicResource TextSecondaryGray}"/>
                                            </Grid>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </StackPanel>
				</StackPanel>
			</ScrollViewer>

			<!-- Bottom section -->
			<StackPanel Grid.Row="2" Margin="0,10">

			<Button x:Name="ActionsButton" Classes="SidebarButton" Foreground="{DynamicResource TextSecondaryGray}">
				<Button.Flyout>
					<Flyout IsOpen="{Binding IsQuickActionsOpen, Mode=TwoWay}" FlyoutPresenterClasses="SidebarFlyout" Placement="RightEdgeAlignedBottom" HorizontalOffset="10">
						<local:QuickActionsMenuView/>
					</Flyout>
				</Button.Flyout>
				<StackPanel Classes="SidebarItem" Orientation="Horizontal">
					<TextBlock Text="+" FontSize="22" FontWeight="Bold" Width="24" TextAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}"/>
					<TextBlock Text="New" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}"/>
				</StackPanel>
			</Button>

				<Button Classes="SidebarButton" Foreground="{DynamicResource TextSecondaryGray}">
					<StackPanel Classes="SidebarItem" Orientation="Horizontal">
						<TextBlock Text="?" FontSize="18" FontWeight="Bold" Width="24" TextAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}"/>
						<TextBlock Text="Help" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}"/>
					</StackPanel>
				</Button>

				<Button x:Name="SettingsButton" Classes="SidebarButton" Padding="0" HorizontalAlignment="Stretch">
					<Button.Flyout>
						<Flyout IsOpen="{Binding IsSettingsOpen, Mode=TwoWay}" FlyoutPresenterClasses="SidebarFlyout" Placement="RightEdgeAlignedBottom" HorizontalOffset="10">
							<local:SettingsMenuView/>
						</Flyout>
					</Button.Flyout>
					<Grid ColumnDefinitions="Auto, *" Margin="20,15">
						<Border Width="32" Height="32" CornerRadius="16" Background="{DynamicResource PrimaryTeal}">
							<TextBlock Text="{Binding UserInitials}" Foreground="White" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
						</Border>
						<TextBlock Grid.Column="1" Text="{Binding UserEmail}" IsVisible="{Binding !IsCollapsed}"
								   VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}"
								   Margin="10,0,0,0" TextTrimming="CharacterEllipsis"/>
					</Grid>
				</Button>

				 <!-- Action Feedback Display -->
				<TextBlock Text="{Binding LastActionMessage}"
						   FontSize="11"
						   Foreground="{DynamicResource TextTertiarySlate}"
						   HorizontalAlignment="Stretch"
						   Margin="10,0,10,5"
						   TextWrapping="Wrap"
						   TextAlignment="Center"/>

                <!-- Setup / Version Info -->
                <StackPanel Margin="0,0,0,10" IsVisible="{Binding !IsCollapsed}">
                    <TextBlock Text="POWERED BY ORIGIZE63" 
                               FontSize="9" 
                               FontWeight="Bold"
                               HorizontalAlignment="Center" 
                               Foreground="{DynamicResource TextTertiarySlate}"
                               Opacity="0.6"/>
                    <TextBlock Text="{Binding AppVersion}" 
                               FontSize="9" 
                               HorizontalAlignment="Center" 
                               Foreground="{DynamicResource TextTertiarySlate}"
                               Opacity="0.5"/>
                     <Button Content="Check Updates" 
                            Command="{Binding CheckForUpdatesCommand}"
                            FontSize="10"
                            HorizontalAlignment="Center"
                            Background="Transparent"
                            BorderThickness="0"
                            Foreground="{DynamicResource AccentOrange}"/>
                </StackPanel>
			</StackPanel>
		</Grid>
	</Border>
</UserControl>
