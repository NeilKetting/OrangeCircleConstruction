<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:vm="clr-namespace:OCC.Client.ViewModels.Core;assembly=OCC.Client"
			 xmlns:conv="clr-namespace:OCC.Client.Converters;assembly=OCC.Client"
			 xmlns:local="clr-namespace:OCC.Client.Views.Shared"
			 xmlns:menus="clr-namespace:OCC.Client.Views.Core.PopupMenus;assembly=OCC.Client"
			 xmlns:converters="using:Avalonia.Data.Converters"
			 mc:Ignorable="d" d:DesignWidth="250" d:DesignHeight="800"
			 x:Class="OCC.Client.Views.Core.SideMenuView"
			 x:DataType="vm:SideMenuViewModel"
			 Focusable="True"
			 PointerPressed="Sidebar_PointerPressed">

	<!-- Design Time Context -->
	<Design.DataContext>
		<vm:SideMenuViewModel/>
	</Design.DataContext>

	<UserControl.Resources>
		<!-- Converter to handle string equality logic for active menu highlighting -->
		<conv:StringEqualityConverter x:Key="StringEqualityConverter"/>
		<!-- Converter for sidebar width -->
		<conv:CollapseWidthConverter x:Key="CollapseWidthConverter"/>
	</UserControl.Resources>

	<UserControl.KeyBindings>
		<KeyBinding Gesture="T" Command="{Binding NewTaskCommand}"/>
		<KeyBinding Gesture="M" Command="{Binding NewMeetingCommand}"/>
		<KeyBinding Gesture="P" Command="{Binding NewProjectCommand}"/>
		<KeyBinding Gesture="I" Command="{Binding InviteUserCommand}"/>
	</UserControl.KeyBindings>

	<UserControl.Styles>
		<!-- Style for Logo Container -->
		<Style Selector="StackPanel.LogoContainer">
			<Setter Property="Margin" Value="20,0,0,0"/>
			<Setter Property="HorizontalAlignment" Value="Left"/>
		</Style>

		<!-- Collapsed State: Remove margin and center content -->
		<Style Selector="StackPanel.LogoContainer.Collapsed">
			<Setter Property="Margin" Value="0"/>
			<Setter Property="HorizontalAlignment" Value="Center"/>
		</Style>

		<!-- Fade Text Class -->
		<Style Selector="TextBlock.FadeText">
			<Setter Property="Opacity" Value="0"/>
			<Setter Property="Transitions">
				<Transitions>
					<DoubleTransition Property="Opacity" Duration="0:0:0.5"/>
				</Transitions>
			</Setter>
		</Style>
		<Style Selector="TextBlock.FadeText.Visible">
			<Setter Property="Opacity" Value="1"/>
		</Style>
	</UserControl.Styles>

	<Border Background="{DynamicResource SurfaceLightGray}"
			Width="{Binding IsCollapsed, Converter={StaticResource CollapseWidthConverter}}">
		<Grid>
			<!-- Main Sidebar Layout -->
			<Grid.RowDefinitions>
				<!-- Logo area -->
				<RowDefinition Height="60"/>
				<!-- Seperator -->
				<RowDefinition Height="Auto"/>
				<!-- Navigation Buttons -->
				<RowDefinition Height="*"/>
				<RowDefinition Height="Auto"/>
			</Grid.RowDefinitions>

			<!-- Logo area -->
			<StackPanel Grid.Row="0" Classes="LogoContainer" Classes.Collapsed="{Binding IsCollapsed}"
						Orientation="Horizontal" Spacing="10"
						DoubleTapped="Sidebar_DoubleTapped"
						Background="Transparent">
				<!--<Image Source="/Assets/Images/occ-logo.jpg" Stretch="UniformToFill"/>-->
				<Ellipse Width="40" Height="40" Stroke="{DynamicResource AccentOrange}" StrokeThickness="8"/>
				<StackPanel VerticalAlignment="Center" IsVisible="{Binding !IsCollapsed}">
					<TextBlock Text="Orange Circle" VerticalAlignment="Center" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryDark}"/>
					<TextBlock Text="Construction" VerticalAlignment="Center" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryDark}" HorizontalAlignment="Center"/>
				</StackPanel>
			</StackPanel>

			<!-- Separator -->
			<Border Grid.Row="1" Height="2" Background="{DynamicResource PrimaryTeal}" Margin="5,0"/>

			<!-- Navigation Buttons Section -->
			<ScrollViewer Grid.Row="2">
				<StackPanel Margin="-2">
					<!-- Home Link -->
					<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding NavigateCommand}" CommandParameter="Home" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Home'}" HorizontalAlignment="Stretch">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconHome}" Classes="IconStyle"/>
							<TextBlock Text="Home" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>

						</StackPanel>
					</Button>

					<!-- Notifications Link -->
					<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding NavigateCommand}" CommandParameter="Notifications" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Notifications'}" HorizontalAlignment="Stretch">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconNotifications}" Classes="IconStyle" Foreground="{Binding NotificationIconColor}"/>
							<TextBlock Text="Notifications" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
							<Border Background="Red" CornerRadius="10" MinWidth="16" Height="16"
									HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,0,10"
									IsVisible="{Binding NotificationVM.NotificationCount, Converter={x:Static converters:ObjectConverters.IsNotNull}}">

								<TextBlock Text="{Binding NotificationVM.NotificationCount, FallbackValue=5}" Foreground="White" FontSize="10" FontWeight="Bold"
										   HorizontalAlignment="Center" VerticalAlignment="Center" Margin="1,0,0,.5"/>
							</Border>
						</StackPanel>
					</Button>

					<!-- Time & Attendance Link -->
					<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding NavigateCommand}" CommandParameter="Time" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Time'}" HorizontalAlignment="Stretch">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconTime}" Classes="IconStyle"/>
							<TextBlock Text="Time &amp; Attendance" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
							
						</StackPanel>
					</Button>

					<!-- Employee Management Link (Visible only if permitted) -->
					<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding NavigateCommand}" CommandParameter="Team" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Team'}" HorizontalAlignment="Stretch" IsVisible="{Binding CanViewStaff}">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconTeam}" Classes="IconStyle"/>
							<TextBlock Text="Employee Management" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<!-- Projects Link -->
					<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding NavigateCommand}" CommandParameter="Portfolio" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Portfolio'}" HorizontalAlignment="Stretch">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconPortfolio}" Classes="IconStyle"/>
							<TextBlock Text="Projects" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<!-- Orders Link -->
					<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding NavigateCommand}" CommandParameter="Orders" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='Orders'}" HorizontalAlignment="Stretch">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconDelivery}" Classes="IconStyle"/>
							<TextBlock Text="Orders" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>

					<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding NavigateCommand}" CommandParameter="HealthSafety" Classes.Active="{Binding ActiveSection, Converter={StaticResource StringEqualityConverter}, ConverterParameter='HealthSafety'}" HorizontalAlignment="Stretch">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconHealthSafety}" Classes="IconStyle"/>
							<TextBlock Text="Health &amp; Safety" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>
				</StackPanel>
			</ScrollViewer>

			<!-- Bottom Action Section (New, Help, Settings, Profile) -->
			<StackPanel Grid.Row="3" Margin="0,10">

				<!-- 'New' Quick Actions Button with Popup -->
				<Grid>
					<Button x:Name="ActionsButton" Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Foreground="{DynamicResource TextSecondaryGray}" Command="{Binding ToggleQuickActionsCommand}">
						<StackPanel Classes="SidebarItem" Orientation="Horizontal">
							<PathIcon Data="{StaticResource IconNew}" Classes="IconStyle"/>
							<TextBlock Text="New" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}"/>
						</StackPanel>
					</Button>
					<Popup IsOpen="{Binding IsQuickActionsOpen, Mode=TwoWay}" PlacementTarget="{Binding ElementName=ActionsButton}" Placement="RightEdgeAlignedBottom" HorizontalOffset="10" IsLightDismissEnabled="True">
						<menus:QuickActionsMenuView/>
					</Popup>
				</Grid>

				<!-- Help Button -->
				<Button Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Foreground="{DynamicResource TextSecondaryGray}" Command="{Binding NavigateCommand}" CommandParameter="Help">
					<StackPanel Classes="SidebarItem" Orientation="Horizontal">
						<PathIcon Data="{StaticResource IconHelp}" Classes="IconStyle"/>
						<TextBlock Text="Help" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}"/>
					</StackPanel>
				</Button>

				<!-- Settings Navigation Button -->
				<!-- Settings Navigation Button -->
				<Grid>
					<Button x:Name="SettingsNavButton" Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" Command="{Binding ToggleSettingsCommand}" HorizontalAlignment="Stretch">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconGear}" Classes="IconStyle"/>
							<TextBlock Text="Settings" IsVisible="{Binding !IsCollapsed}" VerticalAlignment="Center"/>
						</StackPanel>
					</Button>
					<Popup IsOpen="{Binding IsSettingsOpen, Mode=TwoWay}" PlacementTarget="{Binding ElementName=SettingsNavButton}" Placement="RightEdgeAlignedBottom" HorizontalOffset="10" IsLightDismissEnabled="True">
						<menus:SettingsMenuView/>
					</Popup>
				</Grid>

				<!-- User Profile Button with Settings Popup -->
				<!-- User Profile Button with Preferences Popup -->
				<Grid>
					<Button x:Name="ProfileButton" Classes="SidebarButton" Classes.Collapsed="{Binding IsCollapsed}" HorizontalAlignment="Stretch" Command="{Binding TogglePreferencesCommand}">
						<Grid ColumnDefinitions="Auto, *">
							<Border Width="32" Height="32" CornerRadius="16" Background="{DynamicResource PrimaryTeal}">
								<TextBlock Text="{Binding UserInitials}" Foreground="White" FontSize="12" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
							</Border>
							<TextBlock Grid.Column="1" Text="{Binding UserEmail}" IsVisible="{Binding !IsCollapsed}" Margin="10,0,0,0"
									   VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}"
									   TextTrimming="CharacterEllipsis"/>
						</Grid>
					</Button>
					<Popup IsOpen="{Binding IsPreferencesOpen, Mode=TwoWay}" PlacementTarget="{Binding ElementName=ProfileButton}" Placement="RightEdgeAlignedBottom" HorizontalOffset="10" IsLightDismissEnabled="True">
						<menus:PreferencesMenuView/>
					</Popup>
				</Grid>

				<!-- Separator -->
				<Border Height="2" Background="{DynamicResource PrimaryTealHover}" Margin="5,10" IsVisible="{Binding !IsCollapsed}"/>


				<TextBlock Text="{Binding LastActionMessage}"
						   Classes="FadeText"
						   Classes.Visible="{Binding IsMessageVisible}"
						   IsVisible="{Binding !IsCollapsed}"
						   FontSize="11"
						   Foreground="{DynamicResource TextTertiarySlate}"
						   HorizontalAlignment="Stretch"
						   Margin="10,30,10,5"
						   TextWrapping="Wrap"
						   TextAlignment="Center"/>

				<!-- Setup / Version Info -->
				<StackPanel Margin="0,30,0,15" IsVisible="{Binding !IsCollapsed}">
					<TextBlock FontSize="9"
							   FontWeight="Bold"
							   HorizontalAlignment="Center">
						<Run Text="POWERED BY " Foreground="{DynamicResource TextTertiarySlate}"/>
						<Run Text="O" Foreground="#FF00FF"/>
						<Run Text="R" Foreground="Blue"/>
						<Run Text="I" Foreground="#FFFF00"/>
						<Run Text="G" Foreground="Green"/>
						<Run Text="I" Foreground="#FF5F1F"/>
						<Run Text="Z" Foreground="#BC13FE"/>
						<Run Text="E" Foreground="#FF1493"/>
						<Run Text="6" Foreground="#00BFFF"/>
						<Run Text="3" Foreground="Red"/>
					</TextBlock>
					<TextBlock Text="{Binding AppVersion}"
							   FontSize="9"
							   HorizontalAlignment="Center"
							   Foreground="{DynamicResource TextTertiarySlate}"
							   Opacity="0.5"/>
					<Button Content="Check Updates"
							Command="{Binding CheckForUpdatesCommand}"
							FontSize="10"
							HorizontalAlignment="Center"
							Background="Transparent"
							BorderThickness="0"
							Foreground="{DynamicResource AccentOrange}"/>
				</StackPanel>
			</StackPanel>
		</Grid>
	</Border>
</UserControl>
