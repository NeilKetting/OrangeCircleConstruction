<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:vm="clr-namespace:OCC.Client.ViewModels.Home.Tasks"
			 mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="800"
			 x:Class="OCC.Client.Views.Home.Tasks.TaskDetailView"
			 x:DataType="vm:TaskDetailViewModel"
			 xmlns:conv="clr-namespace:OCC.Client.Converters"
			 ClipToBounds="False"
			 Focusable="True">

	<UserControl.Resources>
		<conv:RelativeDateConverter x:Key="RelativeDateConverter"/>
		<conv:NameToInitialsConverter x:Key="NameToInitialsConverter"/>
		<conv:StatusToBrushConverter x:Key="StatusToBrushConverter"/>
		<conv:PercentToSweepAngleConverter x:Key="PercentToSweepAngleConverter"/>
		<conv:TimeSpanToHoursConverter x:Key="TimeSpanToHoursConverter"/>
	</UserControl.Resources>

	<UserControl.KeyBindings>
		<KeyBinding Command="{Binding CloseCommand}" Gesture="Escape"/>
	</UserControl.KeyBindings>

	<UserControl.Styles>
		<Style Selector="TextBox.Seamless">
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="Foreground" Value="{DynamicResource TextPrimaryDark}" />
			<Setter Property="CaretBrush" Value="{DynamicResource TextPrimaryDark}" />
			<Setter Property="Padding" Value="0"/>
			<Setter Property="MinHeight" Value="0"/>
		</Style>
		<!-- Override hover and focus background to keep it seamless and readable -->
		<Style Selector="TextBox.Seamless:pointerover /template/ Border#PART_BorderElement">
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="0"/>
		</Style>
		<Style Selector="TextBox.Seamless:focus /template/ Border#PART_BorderElement">
			<Setter Property="Background" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="0"/>
		</Style>
		<Style Selector="TextBox.Seamless:focus">
			<Setter Property="Background" Value="Transparent"/>
		</Style>
		<!-- Custom CheckBox styling to avoid theme resource conflicts and pixel jumping -->
		<Style Selector="CheckBox.TaskCheck">
			<Setter Property="Padding" Value="8,0,0,0"/>
			<Setter Property="MinWidth" Value="0"/>
			<Setter Property="MinHeight" Value="32"/>
			<Setter Property="Template">
				<ControlTemplate>
					<Grid ColumnDefinitions="Auto, *">
						<Border Grid.Column="0"
								Name="CheckBorder"
								Width="18" Height="18"
								BorderBrush="{DynamicResource TextSecondaryDark}"
								BorderThickness="1"
								CornerRadius="4"
								Background="Transparent"
								VerticalAlignment="Center">
							<Path Name="CheckMark"
								  Data="M 0,0 L 4,4 L 10,-4"
								  Stroke="White"
								  StrokeThickness="2"
								  HorizontalAlignment="Center"
								  VerticalAlignment="Center"
								  Margin="0,3,1,0"/>
						</Border>
						<ContentPresenter Grid.Column="1"
										  Content="{TemplateBinding Content}"
										  Margin="{TemplateBinding Padding}"
										  VerticalAlignment="Center"
										  RecognizesAccessKey="True"/>
					</Grid>
				</ControlTemplate>
			</Setter>
		</Style>
		<Style Selector="CheckBox.TaskCheck /template/ Path#CheckMark">
			<Setter Property="IsVisible" Value="False"/>
		</Style>
		<Style Selector="CheckBox.TaskCheck:checked /template/ Path#CheckMark">
			<Setter Property="IsVisible" Value="True"/>
		</Style>
		<Style Selector="CheckBox.TaskCheck:pointerover /template/ Border#CheckBorder">
			<Setter Property="Background" Value="#10000000"/>
			<Setter Property="BorderBrush" Value="{DynamicResource TextSecondaryDark}"/>
		</Style>
		<Style Selector="CheckBox.TaskCheck:checked /template/ Border#CheckBorder">
			<Setter Property="Background" Value="{DynamicResource PrimaryTeal}"/>
			<Setter Property="BorderBrush" Value="{DynamicResource PrimaryTeal}"/>
		</Style>
	</UserControl.Styles>

	<Border Background="#F4F6F8" CornerRadius="0" BoxShadow="-20 0 40 0 #60000000" ClipToBounds="False">
		<Grid ClipToBounds="False">
			<Grid.ColumnDefinitions>
				<!-- Left Task Details -->
				<ColumnDefinition Width="2*"/>
				<!-- Right Comments -->
				<ColumnDefinition Width="1*"/>
			</Grid.ColumnDefinitions>
			<!-- Left Task Details -->
			<Grid>
				<Grid.RowDefinitions>
					<!-- Top Bar -->
					<RowDefinition Height="60"/>
					<!-- Task Name + Done Checkbox -->
					<RowDefinition Height="Auto"/>
					<!-- Task Indicators -->
					<RowDefinition Height="Auto"/>
					<!-- Description + ToDo List -->
					<RowDefinition Height="Auto"/>
					<!-- Subtasks -->
					<RowDefinition Height="Auto"/>
					<!-- Planed and Actual Dates -->
					<RowDefinition Height="Auto"/>
					<!-- Attachements -->
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>
				<!-- Top Bar (Metadata) -->
				<Grid Grid.Row="0" Height="60" ColumnDefinitions="Auto, *, Auto" Margin="20,0">
					<!-- Task ID -->
					<TextBlock Grid.Column="0" Text="{Binding Id}" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}" FontSize="12"/>

					<!-- Meta Counters & Avatar -->
					<StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
						<!-- Comments -->
						<StackPanel Orientation="Horizontal" Spacing="4">
							<PathIcon Data="{StaticResource IconChat}" Width="14" Height="14" Foreground="{DynamicResource TextSecondaryGray}"/>
							<TextBlock Text="{Binding CommentsCount}" Foreground="{DynamicResource TextSecondaryGray}" FontSize="12"/>
						</StackPanel>
						<!-- Attachments -->
						<StackPanel Orientation="Horizontal" Spacing="4">
							<PathIcon Data="{StaticResource IconAttach}" Width="14" Height="14" Foreground="{DynamicResource TextSecondaryGray}"/>
							<TextBlock Text="{Binding AttachmentsCount}" Foreground="{DynamicResource TextSecondaryGray}" FontSize="12"/>
						</StackPanel>
						<!-- Subtasks -->
						<StackPanel Orientation="Horizontal" Spacing="4">
							<PathIcon Data="{StaticResource IconList}" Width="14" Height="14" Foreground="{DynamicResource TextSecondaryGray}"/>
							<TextBlock Text="{Binding SubtaskCount}" Foreground="{DynamicResource TextSecondaryGray}" FontSize="12"/>
						</StackPanel>

						<!-- Team Member Avatar (Optional placeholder) -->
						<Border Width="24" Height="24" CornerRadius="12" Background="{DynamicResource PrimaryTeal}" BorderBrush="White" BorderThickness="1">
							<TextBlock Text="OR" Foreground="White" FontSize="10" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
						</Border>
					</StackPanel>

					<Separator Grid.ColumnSpan="3" VerticalAlignment="Bottom" Background="{DynamicResource BorderGray}" Height="1" Margin="-20,0"/>
				</Grid>

				<!-- Task Name + Done Checkbox -->
				<Grid Grid.Row="1" ColumnDefinitions="Auto,*, Auto" Margin="20,20">
					<PathIcon Grid.Column="0" Data="{StaticResource IconClipboard}" Classes="IconStyle" Width="16" Height="16"/>
					<TextBox Grid.Column="1" Text="{Binding Title}" Classes="Seamless" FontSize="20" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}" VerticalAlignment="Center" Margin="20,0,0,0"/>
					<StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
						<CheckBox IsChecked="{Binding IsCompleted}" Classes="TaskCheck" VerticalAlignment="Center" Margin="0" Foreground="{DynamicResource TextSecondaryDark}"/>
						<TextBlock Text="Done" VerticalAlignment="Center" Margin="0" Foreground="{DynamicResource TextSecondaryDark}"/>
					</StackPanel>
				</Grid>

				<!-- Task Indicators -->
				<StackPanel Grid.Row="2" Orientation="Horizontal" Margin="20, 10,0,10" Spacing="20">
					<!-- Progress/Status Ring -->
					<StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
						<Button Classes="Ghost" Background="Transparent" Padding="0">
							<Button.Flyout>
								<Flyout Placement="Bottom" ShowMode="TransientWithDismissOnPointerMoveAway">
									<StackPanel Spacing="5" Width="150">
										<Button Command="{Binding SetStatusCommand}" CommandParameter="Not Started" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
											<StackPanel Orientation="Horizontal" Spacing="8">
												<Ellipse Width="12" Height="12" Fill="#CBD5E1"/>
												<TextBlock Text="Not Started"/>
											</StackPanel>
										</Button>
										<Button Command="{Binding SetStatusCommand}" CommandParameter="Started" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
											<StackPanel Orientation="Horizontal" Spacing="8">
												<Ellipse Width="8" Height="8" Fill="{DynamicResource PrimaryTeal}"/>
												<TextBlock Text="Started"/>
											</StackPanel>
										</Button>
										<Button Command="{Binding SetStatusCommand}" CommandParameter="Halfway" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
											<StackPanel Orientation="Horizontal" Spacing="8">
												<Ellipse Width="12" Height="12" Fill="{DynamicResource PrimaryTeal}"/>
												<TextBlock Text="Halfway"/>
											</StackPanel>
										</Button>
										<Button Command="{Binding SetStatusCommand}" CommandParameter="Almost Done" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
											<StackPanel Orientation="Horizontal" Spacing="8">
												<Ellipse Width="12" Height="12" Fill="{DynamicResource PrimaryTeal}"/>
												<TextBlock Text="Almost Done"/>
											</StackPanel>
										</Button>
										<Button Command="{Binding SetStatusCommand}" CommandParameter="Done" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
											<StackPanel Orientation="Horizontal" Spacing="8">
												<Ellipse Width="12" Height="12" Fill="#EF4444"/>
												<TextBlock Text="Done"/>
											</StackPanel>
										</Button>
										<Separator Height="1" Background="#E2E8F0"/>
										<Button Command="{Binding ToggleOnHoldCommand}" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
											<StackPanel Orientation="Horizontal" Spacing="8">
												<PathIcon Data="{StaticResource IconClock}" Width="12" Height="12" Foreground="#22C55E"/>
												<TextBlock Text="On Hold" Foreground="#22C55E"/>
											</StackPanel>
										</Button>
									</StackPanel>
								</Flyout>
							</Button.Flyout>
							<Grid Width="20" Height="20">
								<!-- Background Ring -->
								<Ellipse Stroke="#E2E8F0" StrokeThickness="2" Width="20" Height="20"/>

								<!-- Circular Progress using Arc -->
								<Arc Width="20" Height="20"
									 StartAngle="-90"
									 SweepAngle="{Binding ProgressPercent, Converter={StaticResource PercentToSweepAngleConverter}}"
									 Stroke="{Binding StatusColor, Converter={StaticResource StatusToBrushConverter}}"
									 StrokeThickness="2"/>
							</Grid>
						</Button>
						<TextBlock Text="{Binding ProgressPercent, StringFormat='{}{0}%'}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryDark}" FontSize="14"/>
					</StackPanel>
					<Border Width="1" Height="3" Background="#CBD5E1" VerticalAlignment="Center" />
					<!-- Hours -->
					<StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
						<Ellipse Width="8" Height="8" Fill="{DynamicResource StatusGreen}"/>
						<TextBlock VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}" FontSize="14">
							<Run Text="{Binding ActualHours, TargetNullValue=0}" Foreground="{DynamicResource TextPrimaryDark}"/>
							<Run Text="/"/>
							<Run Text="{Binding PlannedHours, TargetNullValue=0}"/>
							<Run Text=" hours"/>
						</TextBlock>
					</StackPanel>
					<Border Width="1" Height="3" Background="#CBD5E1" VerticalAlignment="Center" />
					<!-- Date -->
					<StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
						<PathIcon Data="{StaticResource IconCalendar}" Width="16" Height="16" Foreground="{DynamicResource TextSecondaryGray}"/>
						<!-- Updated Date Binding -->
						<TextBlock Text="{Binding DueDate, TargetNullValue='None', StringFormat='{}{0:dd MMM}'}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryDark}" FontSize="14"/>
					</StackPanel>

					<Border Width="1" Height="3" Background="#CBD5E1" VerticalAlignment="Center" />

					<!-- Priority -->
					<Button Classes="Ghost" Padding="0">
						<Button.Flyout>
							<Flyout Placement="Bottom" ShowMode="TransientWithDismissOnPointerMoveAway">
								<StackPanel Spacing="2" Width="150">
									<Button Command="{Binding SetPriorityCommand}" CommandParameter="None" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left" Background="#F1F5F9">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<PathIcon Data="{StaticResource IconXCircle}" Width="16" Height="16" Foreground="#1E293B"/> <!-- Dark Icon -->
											<TextBlock Text="None" Foreground="#1E293B" FontWeight="SemiBold"/>
										</StackPanel>
									</Button>

									<Button Command="{Binding SetPriorityCommand}" CommandParameter="Critical" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<PathIcon Data="{StaticResource IconFlame}" Width="16" Height="16" Foreground="#EF4444"/> <!-- Red -->
											<TextBlock Text="Critical" Foreground="#EF4444"/>
										</StackPanel>
									</Button>

									<Button Command="{Binding SetPriorityCommand}" CommandParameter="Very High" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<PathIcon Data="{StaticResource IconArrowUp}" Width="16" Height="16" Foreground="#F59E0B"/> <!-- Orange -->
											<TextBlock Text="Very High" Foreground="#F59E0B"/>
										</StackPanel>
									</Button>

									<Button Command="{Binding SetPriorityCommand}" CommandParameter="High" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<PathIcon Data="{StaticResource IconTriangleUp}" Width="16" Height="16" Foreground="#475569"/> <!-- Slate-600 -->
											<TextBlock Text="High" Foreground="#475569"/>
										</StackPanel>
									</Button>

									<Button Command="{Binding SetPriorityCommand}" CommandParameter="Medium" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<PathIcon Data="{StaticResource IconMinus}" Width="16" Height="16" Foreground="#475569"/>
											<TextBlock Text="Medium" Foreground="#475569"/>
										</StackPanel>
									</Button>

									<Button Command="{Binding SetPriorityCommand}" CommandParameter="Low" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<PathIcon Data="{StaticResource IconTriangleDown}" Width="16" Height="16" Foreground="#475569"/>
											<TextBlock Text="Low" Foreground="#475569"/>
										</StackPanel>
									</Button>

									<Button Command="{Binding SetPriorityCommand}" CommandParameter="Very Low" Classes="Ghost" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left">
										<StackPanel Orientation="Horizontal" Spacing="8">
											<PathIcon Data="{StaticResource IconArrowDown}" Width="16" Height="16" Foreground="#475569"/>
											<TextBlock Text="Very Low" Foreground="#475569"/>
										</StackPanel>
									</Button>
								</StackPanel>
							</Flyout>
						</Button.Flyout>
						<StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
							<PathIcon Data="{StaticResource IconAlertCircle}" Width="16" Height="16" Foreground="{DynamicResource TextSecondaryGray}"/>
							<TextBlock Text="{Binding Priority}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryDark}" FontSize="14"/>
						</StackPanel>
					</Button>

					<Border Width="1" Height="3" Background="#CBD5E1" VerticalAlignment="Center" />

					<!-- Assignees (Tags) -->
					<StackPanel Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
						<ItemsControl ItemsSource="{Binding Assignments}">
							<ItemsControl.ItemsPanel>
								<ItemsPanelTemplate>
									<StackPanel Orientation="Horizontal" Spacing="-8"/>
								</ItemsPanelTemplate>
							</ItemsControl.ItemsPanel>
							<ItemsControl.ItemTemplate>
								<DataTemplate>
									<Border Background="{DynamicResource PrimaryTeal}" CornerRadius="15" Width="30" Height="30" BorderBrush="White" BorderThickness="2" Margin="0,0,5,0" ToolTip.Tip="{Binding AssigneeName}">
										<TextBlock Text="{Binding AssigneeName, Converter={StaticResource NameToInitialsConverter}}" FontSize="10" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
									</Border>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>

						<!-- Add Button -->
						<Button Classes="IconButton" Width="30" Height="30" CornerRadius="15" Background="#E0F2F1" Padding="0" Margin="0">
							<Button.Flyout>
								<Flyout Placement="Bottom" ShowMode="TransientWithDismissOnPointerMoveAway">
									<Border Width="300" Height="300">
										<TabControl>
											<TabItem Header="Staff">
												<ScrollViewer>
													<ItemsControl ItemsSource="{Binding AvailableStaff}">
														<ItemsControl.ItemTemplate>
															<DataTemplate>
																<Grid ColumnDefinitions="*, Auto" Margin="5">
																	<TextBlock Text="{Binding FirstName}" VerticalAlignment="Center"/>
																	<Button Content="+" Command="{Binding $parent[UserControl].((vm:TaskDetailViewModel)DataContext).AssignStaffCommand}" CommandParameter="{Binding}" Classes="IconButton" Width="24" Height="24" Grid.Column="1"/>
																</Grid>
															</DataTemplate>
														</ItemsControl.ItemTemplate>
													</ItemsControl>
												</ScrollViewer>
											</TabItem>

										</TabControl>
									</Border>
								</Flyout>
							</Button.Flyout>
							<PathIcon Data="{StaticResource IconPlus}" Width="12" Height="12" Foreground="{DynamicResource PrimaryTeal}"/>
						</Button>
					</StackPanel>
				</StackPanel>

				<!-- Separator under Indicators -->
				<Separator Grid.Row="2" Background="{DynamicResource BorderGray}" Height="1" VerticalAlignment="Bottom" Margin="0"/>

				<!-- Description + ToDo List -->
				<StackPanel Grid.Row="3" Spacing="25" Margin="20,20">
					<!-- Description -->
					<StackPanel Spacing="10">
						<TextBlock Text="DESCRIPTION" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryGray}"/>
						<TextBox Text="{Binding Description}"
								 AcceptsReturn="True"
								 TextWrapping="Wrap"
								 Classes="Seamless"
								 MinHeight="20"
								 Watermark="Add a description"
								 ScrollViewer.VerticalScrollBarVisibility="Auto"
								 FontSize="14"
								 Foreground="{DynamicResource TextPrimaryDark}"
								 Margin="0,0,0,0"/>
					</StackPanel>

					<!-- To Do List -->
					<StackPanel Spacing="10">
						<TextBlock Text="TO DO LIST" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryGray}"/>

						<StackPanel>
							<!-- List Items -->
							<ItemsControl ItemsSource="{Binding ToDoList}" Margin="0,0,0,0">
								<ItemsControl.ItemTemplate>
									<DataTemplate>
										<Grid ColumnDefinitions="Auto, *" Margin="0,5">
											<CheckBox IsChecked="{Binding IsChecked}" Margin="0,0,10,0" VerticalAlignment="Center"/>
											<TextBox Text="{Binding Content}"
													 Classes="Seamless"
													 VerticalAlignment="Center"
													 Foreground="{DynamicResource TextPrimaryDark}"
													 FontSize="14"/>
										</Grid>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>

							<!-- Add New Item with Connector -->
							<Grid ColumnDefinitions="Auto, *" Margin="3,5,0,0">
								<!-- L-Shaped Connector -->
								<Path Data="M 1,0 L 1,12 L 10,12"
									  Stroke="{DynamicResource BorderGray}"
									  StrokeThickness="1"
									  VerticalAlignment="Top"
									  Margin="6,-8,10,0"
									  Width="15" Height="15"/>

								<TextBox Grid.Column="1"
										 Text="{Binding NewToDoContent}"
										 Watermark="Add To Do"
										 Classes="Seamless"
										 VerticalAlignment="Center"
										 Foreground="{DynamicResource TextPrimaryDark}"
										 FontSize="14"
										 Margin="4,0,0,0">
									<TextBox.KeyBindings>
										<KeyBinding Command="{Binding AddToDoCommand}" Gesture="Enter"/>
									</TextBox.KeyBindings>
								</TextBox>
							</Grid>
						</StackPanel>
					</StackPanel>
				</StackPanel>

				<!-- SUB TASKS -->
				<StackPanel Grid.Row="4" Spacing="15" Margin="20,10,20,0">
					<TextBlock Text="SUBTASKS" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryGray}"/>

					<ItemsControl ItemsSource="{Binding VisibleSubtasks}">
						<ItemsControl.ItemTemplate>
							<DataTemplate>
								<Grid RowDefinitions="Auto, Auto" Margin="0,0,0,15">
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="Auto"/> <!-- Checkbox line -->
										<ColumnDefinition Width="*"/>    <!-- Content -->
										<ColumnDefinition Width="Auto"/> <!-- Popout -->
									</Grid.ColumnDefinitions>

									<!-- Vertical Line (Tree guide) -->
									<Border Grid.RowSpan="2" Grid.Column="0" Width="1" Background="#E2E8F0" HorizontalAlignment="Center" Margin="0,10,0,0"/>

									<!-- Checkbox -->
									<CheckBox Grid.Row="0" Grid.Column="0" IsChecked="{Binding IsComplete}" Classes="TaskCheck" Margin="0,0,15,0" VerticalAlignment="Top"/>

									<!-- Content -->
									<StackPanel Grid.Row="0" Grid.Column="1" Spacing="5">
										<!-- Title -->
										<TextBlock Text="{Binding Name}" FontSize="14" Foreground="{DynamicResource TextPrimaryDark}" VerticalAlignment="Center"/>

										<!-- Meta Row -->
										<StackPanel Orientation="Horizontal" Spacing="15" VerticalAlignment="Center">
											<!-- Progress -->
											<StackPanel Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
												<Border Width="14" Height="14" CornerRadius="7" BorderBrush="{Binding Status, Converter={StaticResource StatusToBrushConverter}}" BorderThickness="2" Background="Transparent"/>
												<TextBlock Text="{Binding PercentComplete, StringFormat='{}{0}%'}" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}"/>
											</StackPanel>

											<Border Width="2" Height="2" CornerRadius="1" Background="{DynamicResource TextSecondaryGray}" VerticalAlignment="Center"/>

											<!-- Hours -->
											<StackPanel Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
												<Ellipse Width="6" Height="6" Fill="#10B981"/> <!-- Green Dot -->
												<TextBlock FontSize="12" Foreground="{DynamicResource TextSecondaryGray}">
													<Run Text="{Binding ActualDuration, Converter={StaticResource TimeSpanToHoursConverter}, Mode=OneWay, StringFormat='{}{0:0}'}" Foreground="{DynamicResource TextSecondaryGray}"/>
													<Run Text="/"/>
													<Run Text="{Binding PlanedDurationHours, Converter={StaticResource TimeSpanToHoursConverter}, Mode=OneWay, TargetNullValue=0, StringFormat='{}{0:0}'}"/>
													<Run Text=" hours"/>
												</TextBlock>
											</StackPanel>

											<Border Width="2" Height="2" CornerRadius="1" Background="{DynamicResource TextSecondaryGray}" VerticalAlignment="Center"/>

											<!-- Date -->
											<StackPanel Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
												<PathIcon Data="{StaticResource IconCalendar}" Width="12" Height="12" Foreground="{DynamicResource TextSecondaryGray}"/>
												<TextBlock Text="{Binding FinishDate, StringFormat='{}{0:MMM d}'}" FontSize="12" Foreground="{DynamicResource TextSecondaryGray}"/>
											</StackPanel>

											<Border Width="2" Height="2" CornerRadius="1" Background="{DynamicResource TextSecondaryGray}" VerticalAlignment="Center"/>

											<!-- Assignee Avatar -->
											<Border Width="20" Height="20" CornerRadius="10" Background="{DynamicResource TextSecondaryGray}" ToolTip.Tip="{Binding AssignedTo}">
												<TextBlock Text="{Binding AssignedTo, Converter={StaticResource NameToInitialsConverter}}" FontSize="9" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
											</Border>

											<!-- Add Assignee Plus Button -->
											<TextBlock Text="+" Foreground="{DynamicResource PrimaryTeal}" FontWeight="Bold" FontSize="14" VerticalAlignment="Center"/>

											<Border Width="2" Height="2" CornerRadius="1" Background="{DynamicResource TextSecondaryGray}" VerticalAlignment="Center"/>

											<!-- Trash -->
											<Button Classes="IconButton" Width="20" Height="20" Padding="0">
												<PathIcon Data="{StaticResource IconTrash}" Width="12" Height="12" Foreground="{DynamicResource TextSecondaryGray}"/>
											</Button>

										</StackPanel>
									</StackPanel>

									<!-- Popout Button -->
									<Button Grid.Row="0" Grid.Column="2"
											Classes="IconButton"
											Command="{Binding $parent[UserControl].((vm:TaskDetailViewModel)DataContext).OpenSubtaskCommand}"
											CommandParameter="{Binding}"
											VerticalAlignment="Top"
											Margin="10,0,0,0">
										<PathIcon Data="{StaticResource IconExternalLink}" Width="14" Height="14" Foreground="{DynamicResource TextSecondaryGray}"/>
									</Button>

								</Grid>
							</DataTemplate>
						</ItemsControl.ItemTemplate>
					</ItemsControl>

					<!-- Show More Button -->
					<Button Classes="Ghost"
							Command="{Binding ShowAllSubtasksCommand}"
							IsVisible="{Binding HasMoreSubtasks}"
							HorizontalAlignment="Left"
							Margin="33,0,0,0">
						<TextBlock Text="Show More" Foreground="{DynamicResource TextSecondaryGray}"/>
					</Button>

					<!-- Add Subtask Placeholer -->
					<Button Command="{Binding AddSubtaskCommand}" Background="Transparent" HorizontalAlignment="Stretch" HorizontalContentAlignment="Left" Margin="0,10,0,0" Padding="0">
						<StackPanel Orientation="Horizontal" Spacing="15">
							<PathIcon Data="{StaticResource IconPlusSquare}" Width="18" Height="18" Foreground="{DynamicResource PrimaryTeal}"/> <!-- Using PlusSquare as checkbox placeholder -->
							<TextBlock Text="Add Subtask" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryGray}" FontWeight="SemiBold"/>
						</StackPanel>
					</Button>
				</StackPanel>

				<!-- Planed and Actual Dates -->
				<Grid Grid.Row="5" RowDefinitions="Auto, Auto, Auto, Auto, Auto" Margin="0,15,0,0">
					<!-- Top Separator -->
					<Separator Grid.Row="0" Background="{DynamicResource BorderGray}" Height="1" />

					<!-- Planned Row -->
					<Border Grid.Row="1" Padding="20,15">
						<Grid ColumnDefinitions="*, Auto, *, Auto, *, Auto, *">
							<StackPanel Grid.Column="0">
								<TextBlock Text="PLANNED START" Classes="LabelSmall" Margin="0,0,0,5"/>
								<Button x:Name="PlannedStartButton" Classes="IconButton" HorizontalAlignment="Left" Padding="0">
									<TextBlock Text="{Binding PlannedStartDate, Converter={StaticResource RelativeDateConverter}}" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
									<Button.Flyout>
										<Flyout Placement="Bottom">
											<Calendar SelectedDate="{Binding PlannedStartDate, Mode=TwoWay}"/>
										</Flyout>
									</Button.Flyout>
								</Button>
							</StackPanel>

							<Border Grid.Column="1" Width="1" Background="{DynamicResource BorderGray}" Margin="15,0"/>

							<StackPanel Grid.Column="2">
								<TextBlock Text="DUE" Classes="LabelSmall" Margin="0,0,0,5"/>
								<Button x:Name="DueButton" Classes="IconButton" HorizontalAlignment="Left" Padding="0">
									<TextBlock Text="{Binding DueDate, Converter={StaticResource RelativeDateConverter}}" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
									<Button.Flyout>
										<Flyout Placement="Bottom">
											<Calendar SelectedDate="{Binding DueDate, Mode=TwoWay}"/>
										</Flyout>
									</Button.Flyout>
								</Button>
							</StackPanel>

							<Border Grid.Column="3" Width="1" Background="{DynamicResource BorderGray}" Margin="15,0"/>

							<StackPanel Grid.Column="4">
								<TextBlock Text="DURATION" Classes="LabelSmall" Margin="0,0,0,5"/>
								<TextBox Text="{Binding PlannedDuration}" Classes="Seamless" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}" LostFocus="Duration_LostFocus"/>
							</StackPanel>

							<Border Grid.Column="5" Width="1" Background="{DynamicResource BorderGray}" Margin="15,0"/>

							<StackPanel Grid.Column="6">
								<TextBlock Text="HOURS" Classes="LabelSmall" Margin="0,0,0,5"/>
								<TextBox Text="{Binding PlannedHours}" Classes="Seamless" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
							</StackPanel>
						</Grid>
					</Border>

					<!-- Middle Separator -->
					<Separator Grid.Row="2" Background="{DynamicResource BorderGray}" Height="1"/>

					<!-- Actual Row -->
					<Border Grid.Row="3" Padding="20,15">
						<Grid ColumnDefinitions="*, Auto, *, Auto, *, Auto, *">
							<StackPanel Grid.Column="0">
								<TextBlock Text="ACTUAL START" Classes="LabelSmall" Margin="0,0,0,5"/>
								<Button x:Name="ActualStartButton" Classes="IconButton" HorizontalAlignment="Left" Padding="0">
									<TextBlock Text="{Binding ActualStartDate, Converter={StaticResource RelativeDateConverter}}" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
									<Button.Flyout>
										<Flyout Placement="Bottom">
											<Calendar SelectedDate="{Binding ActualStartDate, Mode=TwoWay}"/>
										</Flyout>
									</Button.Flyout>
								</Button>
							</StackPanel>

							<Border Grid.Column="1" Width="1" Background="{DynamicResource BorderGray}" Margin="15,0"/>

							<StackPanel Grid.Column="2">
								<TextBlock Text="DONE" Classes="LabelSmall" Margin="0,0,0,5"/>
								<Button x:Name="DoneButton" Classes="IconButton" HorizontalAlignment="Left" Padding="0">
									<TextBlock Text="{Binding DoneDate, Converter={StaticResource RelativeDateConverter}}" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
									<Button.Flyout>
										<Flyout Placement="Bottom">
											<Calendar SelectedDate="{Binding DoneDate, Mode=TwoWay}"/>
										</Flyout>
									</Button.Flyout>
								</Button>
							</StackPanel>

							<Border Grid.Column="3" Width="1" Background="{DynamicResource BorderGray}" Margin="15,0"/>

							<StackPanel Grid.Column="4">
								<TextBlock Text="DURATION" Classes="LabelSmall" Margin="0,0,0,5"/>
								<TextBox Text="{Binding ActualDuration}" Classes="Seamless" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}" LostFocus="Duration_LostFocus"/>
							</StackPanel>

							<Border Grid.Column="5" Width="1" Background="{DynamicResource BorderGray}" Margin="15,0"/>

							<StackPanel Grid.Column="6">
								<TextBlock Text="HOURS" Classes="LabelSmall" Margin="0,0,0,5"/>
								<TextBox Text="{Binding ActualHours}" Classes="Seamless" FontSize="16" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryDark}"/>
							</StackPanel>
						</Grid>
					</Border>
					<Separator Grid.Row="4" Background="{DynamicResource BorderGray}" Height="1"/>
				</Grid>
				<!-- Attachments -->
				<StackPanel Grid.Row="6" Spacing="10" HorizontalAlignment="Left" Margin="20, 15, 0, 0">
					<TextBlock Text="ATTACHMENTS" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryGray}"/>
					<Border BorderBrush="{DynamicResource BorderGray}" BorderThickness="1" Padding="0,30" Height="150" Width="130">
						<StackPanel HorizontalAlignment="Center" Spacing="5">
							<PathIcon Data="{StaticResource IconPlus}" Width="12" Height="12" Foreground="{DynamicResource TextSecondaryGray}" Margin="0,0,0,5"/>
							<TextBlock Text="Drag and" Foreground="{DynamicResource TextSecondaryGray}" FontSize="14" HorizontalAlignment="Center"/>
							<TextBlock Text="drop or" Foreground="{DynamicResource TextSecondaryGray}" FontSize="14" HorizontalAlignment="Center"/>
							<TextBlock Text="browse" Foreground="{DynamicResource TextSecondaryGray}" FontSize="14" HorizontalAlignment="Center"/>
						</StackPanel>
					</Border>
				</StackPanel>
			</Grid>
			<!-- Right Comments -->
			<Border Grid.Column="1" BorderBrush="{DynamicResource BorderGray}" BorderThickness="1,0,0,0" Background="#F8F9FB">
				<Grid RowDefinitions="Auto, Auto, *, Auto">
					<!-- Top Bar / Popup Controls -->
					<Grid Grid.Row="0" ColumnDefinitions="*, Auto" Height="60">
						<StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,20,0" Spacing="15">
							<Button Classes="IconButton" Width="30" Height="30">
								<PathIcon Data="{StaticResource IconMoreVertical}" Width="16" Height="16" Foreground="#1A202C"/>
							</Button>
							<Border Width="1" Height="20" Background="{DynamicResource BorderGray}"/>
							<Button Classes="Close" Command="{Binding CloseCommand}" Width="30" Height="30">
								<PathIcon Data="{StaticResource IconX}" Width="14" Height="14"/>
							</Button>
						</StackPanel>
						<Separator VerticalAlignment="Bottom" Background="{DynamicResource BorderGray}" Height="1" Margin="0"/>
					</Grid>

					<!-- Header -->
					<TextBlock Grid.Row="1" Text="COMMENTS" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryGray}" Margin="20,22,0,0"/>

					<!-- Comments List -->
					<ScrollViewer Grid.Row="2" Margin="0,20,0,0">
						<ItemsControl ItemsSource="{Binding Comments}" Margin="20,0">
							<ItemsControl.ItemTemplate>
								<DataTemplate>
									<Grid ColumnDefinitions="Auto, *">
										<!-- Timeline Line -->
										<Border Grid.Column="0" BorderBrush="#CBD5E1" BorderThickness="1,0,0,0" Margin="15,0,0,0" HorizontalAlignment="Left" ZIndex="0"/>

										<!-- Avatar -->
										<Border Grid.Column="0" Width="30" Height="30" CornerRadius="15" Background="{DynamicResource PrimaryTeal}" VerticalAlignment="Top" HorizontalAlignment="Left" ZIndex="1" Margin="0,0,15,20">
											<TextBlock Text="{Binding Initials}" FontSize="11" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
										</Border>

										<!-- Content -->
										<StackPanel Grid.Column="1" Spacing="5" Margin="0,0,0,30">
											<!-- Header Line -->
											<Grid ColumnDefinitions="*, Auto">
												<TextBlock Grid.Column="0" Text="{Binding AuthorEmail}" FontSize="14" Foreground="{DynamicResource TextPrimaryDark}"/>
												<TextBlock Grid.Column="1" Text="{Binding CreatedAt, StringFormat='{}{0:MMM dd h:mm tt}'}" FontSize="10" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryGray}"/>
											</Grid>

											<!-- Comment Bubble/Text -->
											<Grid>
												<Border Background="#E2E8F0" CornerRadius="4" Padding="10,5" HorizontalAlignment="Left" IsVisible="{Binding Content, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
													<Grid ColumnDefinitions="*, Auto">
														<TextBlock Text="{Binding Content}" TextWrapping="Wrap" FontSize="14" Foreground="{DynamicResource TextPrimaryDark}" MaxWidth="250"/>
														<PathIcon Grid.Column="1" Data="{StaticResource IconMoreHorizontal}" Width="12" Height="12" Foreground="{DynamicResource TextSecondaryGray}" Margin="10,0,0,0" VerticalAlignment="Center"/>
													</Grid>
												</Border>
											</Grid>

											<!-- Emoji/Reaction placeholder -->
											<PathIcon Data="{StaticResource IconSmiley}" Width="16" Height="16" Foreground="{DynamicResource TextSecondaryGray}" HorizontalAlignment="Right" Margin="0,5,0,0"/>
										</StackPanel>
									</Grid>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>
					</ScrollViewer>

					<!-- Input Area -->
					<Border Grid.Row="3" Background="#E2E8F0" Height="50" Margin="20,10,20,20" CornerRadius="4">
						<Grid ColumnDefinitions="*">
							<TextBox Text="{Binding NewCommentContent}"
									 Classes="Seamless"
									 Watermark="Add a comment"
									 VerticalAlignment="Center"
									 Margin="10,0"
									 Foreground="{DynamicResource TextPrimaryDark}"
									 FontSize="14">
								<TextBox.KeyBindings>
									<KeyBinding Command="{Binding AddCommentCommand}" Gesture="Enter"/>
								</TextBox.KeyBindings>
							</TextBox>
						</Grid>
					</Border>
				</Grid>
			</Border>
		</Grid>
	</Border>
</UserControl>
